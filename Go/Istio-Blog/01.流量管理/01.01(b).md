# 虚拟服务

-  阅读大约需要 32 分钟  

影响流量路由的配置。以下是一些在流量路由上下文中有用的术语。

`Service`绑定到服务注册表中唯一名称的应用程序行为单元。服务由多个网络*端点*组成，这些网络 端点由在 pod、容器、VM 等上运行的工作负载实例实现。

`Service versions (a.k.a. subsets)`- 在持续部署场景中，对于给定的服务，可以有不同的实例子集运行不同的应用程序二进制变体。这些变体不一定是不同的 API 版本。它们可以是对同一服务的迭代更改，部署在不同的环境（生产、暂存、开发等）中。发生这种情况的常见场景包括 A/B 测试、金丝雀发布等。可以根据各种标准（标头、url 等）和/或分配给每个版本的权重来决定特定版本的选择。每个服务都有一个由其所有实例组成的默认版本。

`Source`- 调用服务的下游客户端。

`Host`- 客户端尝试连接到服务时使用的地址。

`Access model`- 应用程序仅处理目标服务（主机），而不知道各个服务版本（子集）。版本的实际选择由代理/sidecar 决定，使应用程序代码能够将自身与依赖服务的演化解耦。

A`VirtualService`定义了一组流量路由规则以在寻址主机时应用。每个路由规则都定义了特定协议流量的匹配标准。如果流量匹配，则将其发送到注册表中定义的指定目标服务（或其子集/版本）。

流量来源也可以在路由规则中匹配。这允许为特定的客户端上下文定制路由。

以下 Kubernetes 示例默认将所有 HTTP 流量路由到标签为“版本：v1”的评论服务的 pod。此外，路径以 /wpcatalog/ 或 /consumercatalog/ 开头的 HTTP 请求将被重写为 /newcatalog 并发送到标签为“version: v2”的 pod。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - name: "reviews-v2-routes"
    match:
    - uri:
        prefix: "/wpcatalog"
    - uri:
        prefix: "/consumercatalog"
    rewrite:
      uri: "/newcatalog"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v2
  - name: "reviews-v1-route"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
```

路由目标的子集/版本通过对命名服务子集的引用来标识，该子集必须在相应的 `DestinationRule`.

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: reviews.prod.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

## 虚拟服务

影响流量路由的配置。

| 场地         | 类型              | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 必需的 |
| ---------- | --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| `hosts`    | `string[]`      | 将流量发送到的目标主机。可以是带通配符前缀的 DNS 名称或 IP 地址。根据平台的不同，也可以使用短名称代替 FQDN（即名称中没有点）。在这种情况下，主机的 FQDN 将基于底层平台派生。单个 VirtualService 可用于描述相应主机的所有流量属性，包括多个 HTTP 和 TCP 端口的流量属性。或者，主机的流量属性可以使用多个 VirtualService 来定义，但有一些注意事项。 有关详细信息，请参阅 [操作指南。]*Kubernetes 用户注意事项*：当使用短名称时（例如“reviews”而不是“reviews.default.svc.cluster.local”），Istio 将根据规则的命名空间而不是服务来解释短名称。“默认”命名空间中包含主机“评论”的规则将被解释为“reviews.default.svc.cluster.local”，而不管与评论服务关联的实际命名空间如何。*为避免潜在的错误配置，建议始终使用完全限定的域名而不是短名称。*hosts 字段适用于 HTTP 和 TCP 服务。网格内的服务，即在服务注册表中找到的服务，必须始终使用它们的字母数字名称来引用。IP 地址仅允许用于通过网关定义的服务。*注意*：对于委托 VirtualService，它必须为空。 | 不   |
| `gateways` | `string[]`      | 应应用这些路由的网关和边车的名称。其他命名空间中的网关可能被引用 `<gateway namespace>/<gateway name>`；指定没有命名空间限定符的网关与指定 VirtualService 的命名空间相同。单个 VirtualService 用于网格内的边车以及一个或多个网关。可以使用协议特定路由的匹配条件中的源字段来覆盖此字段强加的选择条件。保留字`mesh`用于表示网格中的所有边车。`mesh`省略此字段时，将使用默认网关 ( )，这会将规则应用于网格中的所有边车。如果提供了网关名称列表，则规则将仅适用于网关。要将规则应用于网关和边车，请指定`mesh`作为网关名称之一。                                                                                                                                                                                                                                                                   | 不   |
| `http`     | `[HTTPRoute[]]` | HTTP 流量路由规则的有序列表。HTTP 路由将应用于使用 HTTP/HTTP2/GRPC 协议的平台服务端口、使用 HTTP/HTTP2/GRPC/TLS-terminated-HTTPS 协议的网关端口和使用 HTTP/HTTP2/GRPC 协议的服务入口端口。使用与传入请求匹配的第一个规则。                                                                                                                                                                                                                                                                                                                                                                                                                        | 不   |
| `tls`      | `[TLSRoute[]]`  | 非终止 TLS 和 HTTPS 流量的路由规则的有序列表。路由通常使用 ClientHello 消息提供的 SNI 值执行。TLS 路由将应用于名为“https- *”、“tls-* ”的平台服务端口、使用 HTTPS/TLS 协议（即“直通”TLS 模式）的未终止网关端口和使用 HTTPS/TLS 协议的服务入口端口。使用与传入请求匹配的第一个规则。注意：没有关联虚拟服务的流量“https- *”或“tls-* ”端口将被视为不透明的 TCP 流量。                                                                                                                                                                                                                                                                                                                                          | 不   |
| `tcp`      | `[TCPRoute[]]`  | 不透明 TCP 流量的路由规则的有序列表。TCP 路由将应用于任何非 HTTP 或 TLS 端口的端口。使用与传入请求匹配的第一个规则。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 不   |
| `exportTo` | `string[]`      | 此虚拟服务导出到的命名空间列表。导出虚拟服务允许它被其他命名空间中定义的边车和网关使用。此功能为服务所有者和网格管理员提供了一种机制来控制跨命名空间边界的虚拟服务的可见性。如果未指定命名空间，则默认情况下将虚拟服务导出到所有命名空间。价值 ”。” 保留并定义到与虚拟服务在其中声明的相同命名空间的导出。类似地，值“*”被保留并定义到所有命名空间的导出。                                                                                                                                                                                                                                                                                                                                                                                              | 不   |

## 目的地

目的地表示处理路由规则后请求/连接将发送到的网络可寻址服务。destination.host 应该明确地引用服务注册表中的服务。Istio 的服务注册表由平台服务注册表中的所有服务（例如，Kubernetes 服务、Consul 服务）以及通过 ServiceEntry 资源声明的服务 [组成]。

*Kubernetes 用户注意事项*：当使用短名称时（例如“reviews”而不是“reviews.default.svc.cluster.local”），Istio 将根据规则的命名空间而不是服务来解释短名称。“默认”命名空间中包含主机“评论”的规则将被解释为“reviews.default.svc.cluster.local”，而不管与评论服务关联的实际命名空间如何。*为避免潜在的错误配置，建议始终使用完全限定的域名而不是短名称。*

以下 Kubernetes 示例在 Kubernetes 环境中默认将所有流量路由到标签为“版本：v1”（即子集 v1）的评论服务的 pod，并将一些流量路由到子集 v2。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
  namespace: foo
spec:
  hosts:
  - reviews # interpreted as reviews.foo.svc.cluster.local
  http:
  - match:
    - uri:
        prefix: "/wpcatalog"
    - uri:
        prefix: "/consumercatalog"
    rewrite:
      uri: "/newcatalog"
    route:
    - destination:
        host: reviews # interpreted as reviews.foo.svc.cluster.local
        subset: v2
  - route:
    - destination:
        host: reviews # interpreted as reviews.foo.svc.cluster.local
        subset: v1
```

以及关联的 DestinationRule

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
  namespace: foo
spec:
  host: reviews # interpreted as reviews.foo.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

以下 VirtualService 为 Kubernetes 中所有对 productpage.prod.svc.cluster.local 服务的调用设置了 5 秒的超时。请注意，此规则中没有定义任何子集。Istio 将从服务注册表中获取 productpage.prod.svc.cluster.local 服务的所有实例，并填充 sidecar 的负载均衡池。另请注意，此规则是在 istio-system 命名空间中设置的，但使用了 productpage 服务的完全限定域名 productpage.prod.svc.cluster.local。因此，规则的命名空间对解析产品页面服务的名称没有影响。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: my-productpage-rule
  namespace: istio-system
spec:
  hosts:
  - productpage.prod.svc.cluster.local # ignores rule namespace
  http:
  - timeout: 5s
    route:
    - destination:
        host: productpage.prod.svc.cluster.local
```

要控制绑定到网格外部服务的流量的路由，必须首先使用 ServiceEntry 资源将外部服务添加到 Istio 的内部服务注册表中。然后可以定义 VirtualServices 来控制绑定到这些外部服务的流量。例如，以下规则为 wikipedia.org 定义了一个服务，并为 HTTP 请求设置了 5 秒的超时。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-wikipedia
spec:
  hosts:
  - wikipedia.org
  location: MESH_EXTERNAL
  ports:
  - number: 80
    name: example-http
    protocol: HTTP
  resolution: DNS
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: my-wiki-rule
spec:
  hosts:
  - wikipedia.org
  http:
  - timeout: 5s
    route:
    - destination:
        host: wikipedia.org
```

| 场地       | 类型               | 描述                                                                                                                                                                                                                                                                                                                                 | 必需的 |
| -------- | ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| `host`   | `string`         | 服务注册表中的服务名称。[服务名称是从平台的服务注册表（例如，Kubernetes 服务、Consul 服务等）和ServiceEntry]声明的主机中查找的。转发到在两者中都找不到的目的地的流量将被丢弃。*Kubernetes 用户注意事项*：当使用短名称时（例如“reviews”而不是“reviews.default.svc.cluster.local”），Istio 将根据规则的命名空间而不是服务来解释短名称。“默认”命名空间中包含主机“评论”的规则将被解释为“reviews.default.svc.cluster.local”，而不管与评论服务关联的实际命名空间如何。为避免潜在的错误配置，建议始终使用完全限定的域名而不是短名称。 | 是的  |
| `subset` | `string`         | 服务中子集的名称。仅适用于网格内的服务。该子集必须在相应的 DestinationRule 中定义。                                                                                                                                                                                                                                                                                 | 不   |
| `port`   | `[PortSelector]` | 指定正在寻址的主机上的端口。如果服务只公开一个端口，则不需要显式选择端口。                                                                                                                                                                                                                                                                                              | 不   |

## HTTP路由

描述路由 HTTP/1.1、HTTP2 和 gRPC 流量的匹配条件和操作。有关使用示例，请参阅 VirtualService。

| 场地                 | 类型                         | 描述                                                                                                                                                                                                                | 必需的 |
| ------------------ | -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| `name`             | `string`                   | 为调试目的分配给路由的名称。路由的名称将与匹配项的名称连接在一起，并将记录在与此路由/匹配项匹配的请求的访问日志中。                                                                                                                                                        | 不   |
| `match`            | `[HTTPMatchRequest[]]`     | 激活规则需要满足的匹配条件。单个匹配块内的所有条件都具有 AND 语义，而匹配块列表具有 OR 语义。如果任何一个匹配块成功，则匹配规则。                                                                                                                                             | 不   |
| `route`            | `[HTTPRouteDestination[]]` | HTTP 规则可以返回 direct_response、重定向或转发（默认）流量。转发目标可以是服务的多个版本之一（请参阅文档开头的词汇表）。与服务版本关联的权重决定了它接收的流量比例。                                                                                                                     | 不   |
| `redirect`         | `[HTTPRedirect]`           | HTTP 规则可以返回 direct_response、重定向或转发（默认）流量。如果在规则中指定了流量直通选项，路由/重定向将被忽略。redirect 原语可用于将 HTTP 301 重定向发送到不同的 URI 或 Authority。                                                                                           | 不   |
| `directResponse`   | `[HTTPDirectResponse]`     | HTTP 规则可以返回 direct_response、重定向或转发（默认）流量。Direct Response 用于指定应发送给客户端的固定响应。`Route`只有当和为空时才可以设置`Redirect`。                                                                                                          | 不   |
| `delegate`         | `[Delegate]`               | Delegate 用于指定可用于定义委托 HTTPRoute 的特定 VirtualService。`Route`只有当和为空时才可以设置`Redirect`，delegate VirtualService的路由规则会和当前的路由规则合并。**注意**：<br><br>1. 仅支持一级委派。<br>2. 委托的 HTTPMatchRequest 必须是根的严格子集，否则会发生冲突并且 HTTPRoute 不会生效。 | 不   |
| `rewrite`          | `[HTTPRewrite]`            | 重写 HTTP URI 和 Authority 标头。重写不能与重定向原语一起使用。重写将在转发之前执行。                                                                                                                                                             | 不   |
| `timeout`          | `[Duration]`               | HTTP 请求超时，默认禁用。                                                                                                                                                                                                   | 不   |
| `retries`          | `[HTTPRetry]`              | HTTP 请求的重试策略。                                                                                                                                                                                                     | 不   |
| `fault`            | `[HTTPFaultInjection]`     | 应用于客户端 HTTP 流量的故障注入策略。请注意，在客户端启用故障时，不会启用超时或重试。                                                                                                                                                                    | 不   |
| `mirror`           | `[Destination]`            | 除了将请求转发到预期目的地之外，还可以将 HTTP 流量镜像到另一个目的地。镜像流量是在尽力而为的基础上进行的，在这种情况下，sidecar/gateway 在从原始目的地返回响应之前不会等待镜像集群响应。将为镜像目标生成统计信息。                                                                                              | 不   |
| `mirrorPercentage` | `[Percent]`                | 该字段要镜像的流量百分比`mirror`。如果此字段不存在，则所有流量 (100%) 都将被镜像。最大值为 100。                                                                                                                                                        | 不   |
| `corsPolicy`       | `[CorsPolicy]`             | 跨源资源共享策略 (CORS)。 有关跨源资源共享的更多详细信息，请参阅 [CORS 。]                                                                                                                                                                     | 不   |
| `headers`          | `[Headers]`                | 标头操作规则                                                                                                                                                                                                            | 不   |

## 代表

描述委托 VirtualService。以下路由规则将流量转发到`/productpage`一个名为 VirtualService 的委托`productpage`，将流量转发到`/reviews`一个名为 的委托 VirtualService `reviews`。

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "bookinfo.com"
  gateways:
  - mygateway
  http:
  - match:
    - uri:
        prefix: "/productpage"
    delegate:
       name: productpage
       namespace: nsA
  - match:
    - uri:
        prefix: "/reviews"
    delegate:
        name: reviews
        namespace: nsB
```

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
  namespace: nsA
spec:
  http:
  - match:
     - uri:
        prefix: "/productpage/v1/"
    route:
    - destination:
        host: productpage-v1.nsA.svc.cluster.local
  - route:
    - destination:
        host: productpage.nsA.svc.cluster.local
```

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
  namespace: nsB
spec:
  http:
  - route:
    - destination:
        host: reviews.nsB.svc.cluster.local
```

| 场地          | 类型       | 描述                                           | 必需的 |
| ----------- | -------- | -------------------------------------------- | --- |
| `name`      | `string` | 名称指定委托 VirtualService 的名称。                   | 不   |
| `namespace` | `string` | 命名空间指定委托 VirtualService 所在的命名空间。默认情况下，它与根相同。 | 不   |

## 标头

当 Envoy 将请求转发到目标服务或来自目标服务的响应时，可以操纵消息标头。可以为特定路由目的地或所有目的地指定标题操作规则。以下 VirtualService 将`test`带有值的标头添加`true` 到路由到任何`reviews`服务目标的请求。它还会删除`foo`响应标头，但仅限于来自服务`v1`子集（版本）的响应`reviews`。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - headers:
      request:
        set:
          test: "true"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v2
      weight: 25
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
      headers:
        response:
          remove:
          - foo
      weight: 75
```

| 场地         | 类型                   | 描述                     | 必需的 |
| ---------- | -------------------- | ---------------------- | --- |
| `request`  | `[HeaderOperations]` | 在将请求转发到目标服务之前应用的标头操作规则 | 不   |
| `response` | `[HeaderOperations]` | 在向调用者返回响应之前应用的标头操作规则   | 不   |

## TLS路由

描述路由未终止的 TLS 流量 (TLS/HTTPS) 的匹配条件和操作 以下路由规则根据 SNI 值将到达称为“mygateway”的网关的端口 443 的未终止的 TLS 流量转发到网格中的内部服务。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-sni
spec:
  hosts:
  - "*.bookinfo.com"
  gateways:
  - mygateway
  tls:
  - match:
    - port: 443
      sniHosts:
      - login.bookinfo.com
    route:
    - destination:
        host: login.prod.svc.cluster.local
  - match:
    - port: 443
      sniHosts:
      - reviews.bookinfo.com
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
```

| 场地      | 类型                       | 描述                                                                    | 必需的 |
| ------- | ------------------------ | --------------------------------------------------------------------- | --- |
| `match` | `[TLSMatchAttributes[]]` | 激活规则需要满足的匹配条件。单个匹配块内的所有条件都具有 AND 语义，而匹配块列表具有 OR 语义。如果任何一个匹配块成功，则匹配规则。 | 是的  |
| `route` | `[RouteDestination[]]`   | 连接应转发到的目的地。                                                           | 不   |

## TCP路由

描述用于路由 TCP 流量的匹配条件和操作。以下路由规则将到达 mongo.prod.svc.cluster.local 端口 27017 的流量转发到端口 5555 上的另一台 Mongo 服务器。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-mongo
spec:
  hosts:
  - mongo.prod.svc.cluster.local
  tcp:
  - match:
    - port: 27017
    route:
    - destination:
        host: mongo.backup.svc.cluster.local
        port:
          number: 5555
```

| 场地      | 类型                      | 描述                                                                    | 必需的 |
| ------- | ----------------------- | --------------------------------------------------------------------- | --- |
| `match` | `[L4MatchAttributes[]]` | 激活规则需要满足的匹配条件。单个匹配块内的所有条件都具有 AND 语义，而匹配块列表具有 OR 语义。如果任何一个匹配块成功，则匹配规则。 | 不   |
| `route` | `[RouteDestination[]]`  | 连接应转发到的目的地。                                                           | 不   |

## HTTP匹配请求

HttpMatchRequest 指定要满足的一组标准，以便将规则应用于 HTTP 请求。例如，以下将规则限制为仅匹配 URL 路径以 /ratings/v2/ 开头且请求包含具有`end-user`value 的自定义标头的请求`jason`。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - headers:
        end-user:
          exact: jason
      uri:
        prefix: "/ratings/v2/"
      ignoreUriCase: true
    route:
    - destination:
        host: ratings.prod.svc.cluster.local
```

HTTPMatchRequest 不能为空。 **笔记：**

1. 如果根 VirtualService 已通过正则表达式匹配任何属性（路径、标头等），则委托 VirtualServices 不应在同一属性上有任何其他匹配项。
2. 如果委托 VirtualService 已通过正则表达式匹配任何属性（路径、标头等），则根 VirtualServices 不应在同一属性上有任何其他匹配项。

| 场地                | 类型                           | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 必需的 |
| ----------------- | ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --- |
| `name`            | `string`                     | 分配给匹配项的名称。匹配的名称将与父路由的名称连接起来，并将记录在与该路由匹配的请求的访问日志中。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 不   |
| `uri`             | `[StringMatch]`              | 匹配值的 URI 区分大小写，格式如下：<br><br>- `exact: "value"`精确的字符串匹配<br>- `prefix: "value"`用于基于前缀的匹配<br>- `regex: "value"`用于 RE2 样式的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。<br><br>**注意：**可以通过标志启用不区分大小写的匹配 `ignore_uri_case`。                                                                                                                                                                                                                                                                                                                                                                                                                                        | 不   |
| `scheme`          | `[StringMatch]`              | URI Scheme 值区分大小写，格式如下：<br><br>- `exact: "value"`精确的字符串匹配<br>- `prefix: "value"`用于基于前缀的匹配<br>- `regex: "value"`用于 RE2 样式的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 不   |
| `method`          | `[StringMatch]`              | HTTP 方法值区分大小写，格式如下：<br><br>- `exact: "value"`精确的字符串匹配<br>- `prefix: "value"`用于基于前缀的匹配<br>- `regex: "value"`用于 RE2 样式的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 不   |
| `authority`       | `[StringMatch]`              | HTTP Authority 值区分大小写，格式如下：<br><br>- `exact: "value"`精确的字符串匹配<br>- `prefix: "value"`用于基于前缀的匹配<br>- `regex: "value"`用于 RE2 样式的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 不   |
| `headers`         | `map<string, [StringMatch]>` | 标头键必须小写并使用连字符作为分隔符，例如*x-request-id*。标头值区分大小写，格式如下：<br><br>- `exact: "value"`精确的字符串匹配<br>- `prefix: "value"`用于基于前缀的匹配<br>- `regex: "value"`用于 RE2 样式的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。<br><br>If the value is empty and only the name of header is specified, presence of the header is checked. **Note:** The keys `uri`, `scheme`, `method`, and `authority` will be ignored.                                                                                                                                                                                                                                                                    | No  |
| `port`            | `uint32`                     | Specifies the ports on the host that is being addressed. Many services only expose a single port or label ports with the protocols they support, in these cases it is not required to explicitly select the port.                                                                                                                                                                                                                                                                                                                                                                                                                                                        | No  |
| `sourceLabels`    | `map<string, string>`        | One or more labels that constrain the applicability of a rule to source (client) workloads with the given labels. If the VirtualService has a list of gateways specified in the top-level `gateways` field, it must include the reserved gateway `mesh` for this field to be applicable.                                                                                                                                                                                                                                                                                                                                                                                 | No  |
| `gateways`        | `string[]`                   | Names of gateways where the rule should be applied. Gateway names in the top-level `gateways` field of the VirtualService (if any) are overridden. The gateway match is independent of sourceLabels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | No  |
| `queryParams`     | `map<string, [StringMatch]>` | Query parameters for matching.Ex:<br><br>- For a query parameter like “?key=true”, the map key would be “key” and the string match could be defined as `exact: "true"`.<br>- For a query parameter like “?key”, the map key would be “key” and the string match could be defined as `exact: ""`.<br>- For a query parameter like “?key=abc” or “?key=abx”, the map key would be “key” and the string match could be defined as `prefix: "ab"`.<br>- For a query parameter like “?key=123”, the map key would be “key” and the string match could be defined as `regex: "\d+$"`. Note that this configuration will only match values like “123” but not “a123” or “123a”. | No  |
| `ignoreUriCase`   | `bool`                       | Flag to specify whether the URI matching should be case-insensitive.**Note:** The case will be ignored only in the case of `exact` and `prefix` URI matches.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | No  |
| `withoutHeaders`  | `map<string, [StringMatch]>` | withoutHeader has the same syntax with the header, but has opposite meaning. If a header is matched with a matching rule among withoutHeader, the traffic becomes not matched one.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | No  |
| `sourceNamespace` | `string`                     | Source namespace constraining the applicability of a rule to workloads in that namespace. If the VirtualService has a list of gateways specified in the top-level `gateways` field, it must include the reserved gateway `mesh` for this field to be applicable.                                                                                                                                                                                                                                                                                                                                                                                                         | No  |
| `statPrefix`      | `string`                     | The human readable prefix to use when emitting statistics for this route. The statistics are generated with prefix route.<stat_prefix>. This should be set for highly critical routes that one wishes to get “per-route” statistics on. This prefix is only for proxy-level statistics (envoy_*) and not service-level (istio_*) statistics. Refer to [HTTP route components (proto) &mdash; envoy 1.27.0-dev-de3ae4 documentation] for statistics that are generated when this is configured.                                                                                                                                                                           | No  |

## HTTPRouteDestination

每个路由规则都与一个或多个服务版本相关联（请参阅文档开头的词汇表）。与版本关联的权重决定了它接收的流量比例。例如，以下规则会将“评论”服务的 25% 流量路由到带有“v2”标签的实例，并将剩余流量（即 75%）路由到“v1”。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v2
      weight: 25
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
      weight: 75
```

以及关联的 DestinationRule

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: reviews.prod.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

还可以将流量拆分到两个完全不同的服务中，而无需定义新的子集。例如，以下规则将 25% 的流量转发到 reviews.com 到 dev.reviews.com

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route-two-domains
spec:
  hosts:
  - reviews.com
  http:
  - route:
    - destination:
        host: dev.reviews.com
      weight: 25
    - destination:
        host: reviews.com
      weight: 75
```

| 场地            | 类型              | 描述                                                                                                              | 必需的 |
| ------------- | --------------- | --------------------------------------------------------------------------------------------------------------- | --- |
| `destination` | `[Destination]` | 目的地唯一标识请求/连接应转发到的服务实例。                                                                                          | 是的  |
| `weight`      | `int32`         | 权重指定要转发到目的地的流量的相对比例。目的地将接收`weight/(sum of all weights)`请求。如果规则中只有一个目的地，它将接收所有流量。否则，如果 weight 是`0`，目的地将不会收到任何流量。 | 不   |
| `headers`     | `[Headers]`     | 标头操作规则                                                                                                          | 不   |

## 路线目的地

L4 路由规则加权目的地。

| 场地            | 类型              | 描述                                                                                                              | 必需的 |
| ------------- | --------------- | --------------------------------------------------------------------------------------------------------------- | --- |
| `destination` | `[Destination]` | 目的地唯一标识请求/连接应转发到的服务实例。                                                                                          | 是的  |
| `weight`      | `int32`         | 权重指定要转发到目的地的流量的相对比例。目的地将接收`weight/(sum of all weights)`请求。如果规则中只有一个目的地，它将接收所有流量。否则，如果 weight 是`0`，目的地将不会收到任何流量。 | 不   |

## L4匹配属性

L4 连接匹配属性。请注意，L4 连接匹配支持不完整。

| 场地                   | 类型                    | 描述                                                                                                   | 必需的 |
| -------------------- | --------------------- | ---------------------------------------------------------------------------------------------------- | --- |
| `destinationSubnets` | `string[]`            | 带有可选子网的目标 IPv4 或 IPv6 IP 地址。例如，abcd/xx 形式或只是 abcd                                                    | 不   |
| `port`               | `uint32`              | 指定正在寻址的主机上的端口。许多服务只公开一个端口或使用它们支持的协议标记端口，在这些情况下不需要明确选择端口。                                             | 不   |
| `sourceLabels`       | `map<string, string>` | 一个或多个标签，用于限制规则对具有给定标签的工作负载的适用性。如果 VirtualService 有一个在顶级`gateways`字段中指定的网关列表，它应该包括保留网关 `mesh`以便该字段适用。 | 不   |
| `gateways`           | `string[]`            | 应应用规则的网关的名称。`gateways`VirtualService 的顶级字段中的网关名称（如果有）被覆盖。网关匹配独立于 sourceLabels。                       | 不   |
| `sourceNamespace`    | `string`              | 源命名空间限制规则对该命名空间中工作负载的适用性。如果 VirtualService 具有在顶级字段中指定的网关列表，则它必须包含此字段适用的`gateways`保留网关。`mesh`         | 不   |

## TLSMatch属性

TLS 连接匹配属性。

| 场地                   | 类型                    | 描述                                                                                                                                                                                                                                                                                  | 必需的 |
| -------------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| `sniHosts`           | `string[]`            | 要匹配的 SNI（服务器名称指示器）。可以在 SNI 值中使用通配符前缀，例如，*.com 将匹配 foo.example.com 以及 example.com。SNI 值必须是相应虚拟服务主机的子集（即属于域内）。                                                                                                                                                                        | 是的  |
| `destinationSubnets` | `string[]`            | 带有可选子网的目标 IPv4 或 IPv6 IP 地址。例如，abcd/xx 形式或只是 abcd                                                                                                                                                                                                                                   | 不   |
| `port`               | `uint32`              | Specifies the port on the host that is being addressed. Many services only expose a single port or label ports with the protocols they support, in these cases it is not required to explicitly select the port.                                                                    | No  |
| `sourceLabels`       | `map<string, string>` | One or more labels that constrain the applicability of a rule to workloads with the given labels. If the VirtualService has a list of gateways specified in the top-level `gateways` field, it should include the reserved gateway `mesh` in order for this field to be applicable. | No  |
| `gateways`           | `string[]`            | Names of gateways where the rule should be applied. Gateway names in the top-level `gateways` field of the VirtualService (if any) are overridden. The gateway match is independent of sourceLabels.                                                                                | No  |
| `sourceNamespace`    | `string`              | 源命名空间限制规则对该命名空间中工作负载的适用性。如果 VirtualService 具有在顶级字段中指定的网关列表，则它必须包含此字段适用的`gateways`保留网关。`mesh`                                                                                                                                                                                        | 不   |

## HTTP重定向

HTTPRedirect 可用于向调用方发送 301 重定向响应，其中 Authority/Host 和响应中的 URI 可与指定值交换。例如，以下规则将对评级服务上的 /v1/getProductRatings API 的请求重定向到 bookratings 服务提供的 /v1/bookRatings。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - uri:
        exact: /v1/getProductRatings
    redirect:
      uri: /v1/bookRatings
      authority: newratings.default.svc.cluster.local
  ...
```

| 场地             | 类型                                | 描述                                                                                                                  | 必需的 |
| -------------- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------- | --- |
| `uri`          | `string`                          | 在重定向时，用此值覆盖 URL 的路径部分。请注意，无论请求 URI 是否匹配为精确路径或前缀，整个路径都将被替换。                                                          | 不   |
| `authority`    | `string`                          | 在重定向时，使用此值覆盖 URL 的权限/主机部分。                                                                                          | 不   |
| `port`         | `uint32 (oneof)`                  | 在重定向时，用此值覆盖 URL 的端口部分。                                                                                              | 不   |
| `derivePort`   | `[RedirectPortSelection (oneof)]` | 在重定向时，动态设置端口：<br><br>- FROM_PROTOCOL_DEFAULT：对于 HTTP 自动设置为 80，对于 HTTPS 自动设置为 443。<br>- FROM_REQUEST_PORT：自动使用请求的端口。 | 不   |
| `scheme`       | `string`                          | 在重定向时，用此值覆盖 URL 的方案部分。例如，`http`或`https`。如果未设置，将使用原始方案。如果`derivePort`设置为`FROM_PROTOCOL_DEFAULT`，这也会影响使用的端口           | 不   |
| `redirectCode` | `uint32`                          | 在重定向上，指定要在重定向响应中使用的 HTTP 状态代码。默认响应代码是 MOVED_PERMANENTLY (301)。                                                      | 不   |

## HTTPDirectResponse

HTTPDirectResponse 可用于向客户端发送固定响应。例如，以下规则返回一个固定的 503 状态，其中包含对 /v1/getProductRatings API 请求的正文。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - uri:
        exact: /v1/getProductRatings
    directResponse:
      status: 503
      body:
        string: "unknown error"
  ...
```

也可以指定二进制响应主体。这对于非基于文本的协议（例如 gRPC）非常有用。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - uri:
        exact: /v1/getProductRatings
    directResponse:
      status: 503
      body:
        bytes: "dW5rbm93biBlcnJvcg==" # "unknown error" in base64
  ...
```

最好在 HTTPRoute 和 direct_response 中添加标头，例如指定返回的 Content-Type。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - uri:
        exact: /v1/getProductRatings
    directResponse:
      status: 503
      body:
        string: "{\"error\": \"unknown error\"}"
    headers:
      response:
        set:
          content-type: "appliation/json"
  ...
```

| 场地       | 类型           | 描述                              | 必需的 |
| -------- | ------------ | ------------------------------- | --- |
| `status` | `uint32`     | 指定要返回的 HTTP 响应状态。               | 是的  |
| `body`   | `[HTTPBody]` | 指定响应主体的内容。如果省略此设置，则生成的响应中不包含正文。 | 不   |

## HTTP正文

| 场地       | 类型               | 描述                 | 必需的 |
| -------- | ---------------- | ------------------ | --- |
| `string` | `string (oneof)` | 作为字符串的响应主体         | 不   |
| `bytes`  | `bytes (oneof)`  | 响应主体为 base64 编码字节。 | 不   |

## HTTP重写

HTTPRewrite 可用于在将请求转发到目标之前重写 HTTP 请求的特定部分。重写原语只能与 HTTPRouteDestination 一起使用。以下示例演示如何在进行实际 API 调用之前将 api 调用的 URL 前缀 (/ratings) 重写为评级服务。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - uri:
        prefix: /ratings
    rewrite:
      uri: /v1/bookRatings
    route:
    - destination:
        host: ratings.prod.svc.cluster.local
        subset: v1
```

| 场地          | 类型       | 描述                                                           | 必需的 |
| ----------- | -------- | ------------------------------------------------------------ | --- |
| `uri`       | `string` | 用这个值重写 URI 的路径（或前缀）部分。如果原始 URI 是基于前缀匹配的，则此字段中提供的值将替换相应的匹配前缀。 | 不   |
| `authority` | `string` | 使用此值重写 Authority/Host 标头。                                    | 不   |

## 字符串匹配

描述如何匹配 HTTP 标头中的给定字符串。匹配区分大小写。

| 场地       | 类型               | 描述                                                              | 必需的 |
| -------- | ---------------- | --------------------------------------------------------------- | --- |
| `exact`  | `string (oneof)` | 精确的字符串匹配                                                        | 不   |
| `prefix` | `string (oneof)` | 基于前缀的匹配                                                         | 不   |
| `regex`  | `string (oneof)` | RE2 风格的基于正则表达式的匹配（[https://github.com/google/re2/wiki/Syntax）]。 | 不   |

## HTTP重试

Describes the retry policy to use when a HTTP request fails. For example, the following rule sets the maximum number of retries to 3 when calling ratings:v1 service, with a 2s timeout per retry attempt. A retry will be attempted if there is a connect-failure, refused_stream or when the upstream server responds with Service Unavailable(503).

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - route:
    - destination:
        host: ratings.prod.svc.cluster.local
        subset: v1
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: connect-failure,refused-stream,503
```

| Field                   | Type          | Description                                                                                                                                                                                                                                                                                                                     | Required |
| ----------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| `attempts`              | `int32`       | Number of retries to be allowed for a given request. The interval between retries will be determined automatically (25ms+). When request `timeout` of the [HTTP route] or `per_try_timeout` is configured, the actual number of retries attempted also depends on the specified request `timeout` and `per_try_timeout` values. | Yes      |
| `perTryTimeout`         | `[Duration]`  | Timeout per attempt for a given request, including the initial call and any retries. Format: 1h/1m/1s/1ms. MUST BE >=1ms. Default is same value as request `timeout` of the [HTTP route], which means no timeout.                                                                                                               | No       |
| `retryOn`               | `string`      | Specifies the conditions under which retry takes place. One or more policies can be specified using a ‘,’ delimited list. If `retry_on` specifies a valid HTTP status, it will be added to retriable_status_codes retry policy. See the [retry policies] for more details.                                                      | No       |
| `retryRemoteLocalities` | `[BoolValue]` | Flag to specify whether the retries should retry to other localities. See the [retry plugin configuration] for more details.                                                                                                                                                                                                    | No       |

## CorsPolicy

描述给定服务的跨源资源共享 (CORS) 策略。 有关跨源资源共享的更多详细信息，请参阅[CORS 。]例如，以下规则将跨源请求限制为使用 HTTP POST/GET 源自 example.com 域的请求，并将标头设置 `Access-Control-Allow-Credentials`为 false。此外，它只公开`X-Foo-bar`标头并设置 1 天的有效期。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - route:
    - destination:
        host: ratings.prod.svc.cluster.local
        subset: v1
    corsPolicy:
      allowOrigins:
      - exact: https://example.com
      allowMethods:
      - POST
      - GET
      allowCredentials: false
      allowHeaders:
      - X-Foo-Bar
      maxAge: "24h"
```

| 场地                 | 类型                | 描述                                                                                     | 必需的 |
| ------------------ | ----------------- | -------------------------------------------------------------------------------------- | --- |
| `allowOrigins`     | `[StringMatch[]]` | 匹配允许来源的字符串模式。如果任何字符串匹配器匹配，则允许来源。如果找到匹配项，则传出的 Access-Control-Allow-Origin 将设置为客户端提供的来源。 | 不   |
| `allowMethods`     | `string[]`        | 允许访问资源的 HTTP 方法列表。内容将被序列化到 Access-Control-Allow-Methods 标头中。                           | 不   |
| `allowHeaders`     | `string[]`        | 请求资源时可以使用的 HTTP 标头列表。序列化为 Access-Control-Allow-Headers 标头。                             | 不   |
| `exposeHeaders`    | `string[]`        | 允许浏览器访问的 HTTP 标头列表。序列化为 Access-Control-Expose-Headers 标头。                              | 不   |
| `maxAge`           | `[Duration]`      | 指定预检请求的结果可以缓存多长时间。翻译成`Access-Control-Max-Age`标题。                                       | 不   |
| `allowCredentials` | `[BoolValue]`     | 指示是否允许调用方使用凭据发送实际请求（而非预检）。翻译成 `Access-Control-Allow-Credentials`标题。                    | 不   |

## HTTP故障注入

HTTPFaultInjection 可用于指定在将 HTTP 请求转发到路由中指定的目的地时要注入的一个或多个故障。故障规范是 VirtualService 规则的一部分。故障包括中止来自下游服务的 Http 请求，和/或延迟请求代理。故障规则必须具有延迟或中止或两者兼而有之。

*注意：*延迟和中止故障彼此独立，即使同时指定两者也是如此。

| 场地      | 类型        | 描述                                         | 必需的 |
| ------- | --------- | ------------------------------------------ | --- |
| `delay` | `[Delay]` | 在转发之前延迟请求，模拟各种故障，例如网络问题，上游服务过载等。           | 不   |
| `abort` | `[Abort]` | 中止 Http 请求尝试并将错误代码返回给下游服务，给人一种上游服务出现故障的印象。 | 不   |

## 端口选择器

PortSelector 指定用于匹配或选择最终路由的端口号。

| 场地       | 类型       | 描述    | 必需的 |
| -------- | -------- | ----- | --- |
| `number` | `uint32` | 有效端口号 | 不   |

## 百分

百分比指定 [0.0, 100.0] 范围内的百分比。

| 场地      | 类型       | 描述  | 必需的 |
| ------- | -------- | --- | --- |
| `value` | `double` |     | 不   |

## Headers.HeaderOperations

HeaderOperations 描述要应用的标头操作

| 场地       | 类型                    | 描述                            | 必需的 |
| -------- | --------------------- | ----------------------------- | --- |
| `set`    | `map<string, string>` | 用给定的值覆盖键指定的标头                 | 不   |
| `add`    | `map<string, string>` | 将给定值附加到由键指定的标头（将创建一个逗号分隔的值列表） | 不   |
| `remove` | `string[]`            | 删除指定的标头                       | 不   |

## HTTPFaultInjection.Delay

延迟规范用于将延迟注入请求转发路径。以下示例将在每 1000 次请求中有 1 次从标签为 env 的所有 pod 对“reviews”服务的“v1”版本的请求中引入 5 秒的延迟：prod

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - match:
    - sourceLabels:
        env: prod
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
```

*fixedDelay*字段用于指示以秒为单位的延迟量。可选的*百分比*字段可用于仅延迟一定百分比的请求。如果未指定，则不会延迟任何请求。

| 场地           | 类型                   | 描述                                                         | 必需的 |
| ------------ | -------------------- | ---------------------------------------------------------- | --- |
| `fixedDelay` | `[Duration (oneof)]` | 在转发请求之前添加固定延迟。格式：1h/1m/1s/1ms。必须 >=1 毫秒。                   | 是的  |
| `percentage` | `[Percent]`          | 将注入延迟的请求的百分比。如果未指定，则不会延迟任何请求。                              | 不   |
| `percent`    | `int32`              | 将注入延迟的请求百分比 (0-100)。`percent`不推荐使用整数值。请改用双`percentage` 字段。 | 不   |

## HTTPFaultInjection.Abort

中止规范用于过早中止具有预先指定的错误代码的请求。以下示例将向“评级”服务“v1”的每 1000 个请求中的 1 个返回 HTTP 400 错误代码。

v1alpha3v1beta1

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - route:
    - destination:
        host: ratings.prod.svc.cluster.local
        subset: v1
    fault:
      abort:
        percentage:
          value: 0.1
        httpStatus: 400
```

*httpStatus*字段用于指示返回给调用者的 HTTP 状态代码。可选*百分比*字段可用于仅中止特定百分比的请求。如果未指定，则不会中止任何请求。

| 场地           | 类型               | 描述                                                                                       | 必需的 |
| ------------ | ---------------- | ---------------------------------------------------------------------------------------- | --- |
| `httpStatus` | `int32 (oneof)`  | 用于中止 Http 请求的 HTTP 状态代码。                                                                 | 是的  |
| `grpcStatus` | `string (oneof)` | 用于中止请求的 GRPC 状态代码。支持的代码记录在[grpc/statuscodes.md at master · grpc/grpc · GitHub], 但不是`14`。 | 不   |
| `percentage` | `[Percent]`      | 使用提供的错误代码中止的请求百分比。如果未指定，则不会中止任何请求。                                                       | 不   |


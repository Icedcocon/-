# SSH

### 1 配置root用户登录

- ubuntu 上的sshd默认root用户不可登录，因此需要修改`/etc/ssh/sshd_config`中的配置并重新启动sshd服务

```bash
#root远程登录
sed -ri 's/#PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
systemctl restart sshd.service 
```

### 2 配置集群用户免密登录

- 手动设置

```bash
ssh-keygen -b 1024 -t rsa
# 回车*n
ssh-copy-id root@目标IP
# 输入密码
```

- 集群免密登录

```bash
function configSsh() {
    all_ips_file=config/all-ips    # all-ips 存放所有节点的IP地址

    SSH_DIR=/root/.ssh
    SCRIPT_PREFIX=./tmp
    echo ===========================
    # 1. prepare  directory .ssh
    rm -rf $SSH_DIR
    mkdir -p $SSH_DIR
    chmod 700 $SSH_DIR

    # 2. generate ssh key
    TMP_SCRIPT=$SCRIPT_PREFIX.sh
    echo  "#!/usr/bin/expect">$TMP_SCRIPT
    echo  "spawn ssh-keygen -b 1024 -t rsa">>$TMP_SCRIPT
    echo  "expect *key*">>$TMP_SCRIPT
    echo  "send \r">>$TMP_SCRIPT
    if [ -f $SSH_DIR/id_rsa ]; then
        echo  "expect *verwrite*">>$TMP_SCRIPT
        echo  "send y\r">>$TMP_SCRIPT
    fi
    echo  "expect *passphrase*">>$TMP_SCRIPT
    echo  "send \r">>$TMP_SCRIPT
    echo  "expect *again:">>$TMP_SCRIPT
    echo  "send \r">>$TMP_SCRIPT
    echo  "interact">>$TMP_SCRIPT

    chmod +x $TMP_SCRIPT

    /usr/bin/expect $TMP_SCRIPT
    rm -rf $TMP_SCRIPT

    # 3. generate file authorized_keys
    cat $SSH_DIR/id_rsa.pub>>$SSH_DIR/authorized_keys

    # 4. chmod 600 for file authorized_keys
    chmod 600 $SSH_DIR/authorized_keys
    echo ===========================
    # 5. copy all files to other hosts
    for ip in $(cat $all_ips_file)
    do
        if [ ${ip} != ${MASTER1_IP} ]; then
            sshpass -p ${PASSWORD} ssh -q -o StrictHostKeyChecking=no root@${ip} "rm -rf /home/check-ssh.sh"
            sshpass -p ${PASSWORD} scp -r shell/check-ssh.sh root@${ip}:/home
            sshpass -p ${PASSWORD} ssh root@${ip} "mkdir -p /root/.ssh"
            sshpass -p ${PASSWORD} scp -r /root/.ssh/authorized_keys root@${ip}:/root/.ssh/authorized_keys.bak
            sshpass -p ${PASSWORD} ssh root@${ip} "cat /root/.ssh/authorized_keys.bak >> /root/.ssh/authorized_keys"
            sshpass -p ${PASSWORD} ssh root@${ip} "chmod 600 /root/.ssh/authorized_keys"
        fi
    done
}
```

### 3 REMOTE HOST IDENTIFICATION HAS CHANGED

- 已记录的IP不再是原来的服务器

```bash
# 方法1 命令重置IP
ssh-keygen -R 出问题的IP 

# 方法2 删除配置文件中对应的IP分记录
sed -ri 's/*IP*//' /etc/.ssh/known_hosts
```

# NTP

### 1 Ubuntu下的time-daemon与ntp

- ubuntu server 20.04 默认使用time-daemon服务实现ntp协议；
- time-daemon服务与ntp冲突导致其不能被dpkg正确安装。
- time-daemon服务是一个pure virtual packages，不能被删除；
- 可以使用以下指令查看和停止time-daemon服务

```bash
timedatectl
timedatectl set-ntp no
```

### 2 ntp配置文件

- `/etc/ntp.conf`：主要配置文件

- `/usr/share/zoneinfo`：由tzdata软件所提供，为各时区的时间格式对应文件。
  
  - 中国时区格式对应文件放在`/usr/share/zoneinfo/Asia/Shanghai`

- `/etc/adjtime`：设定时区与是否使用UTC时间的配置文件，默认为local使用CST时间

- `/etc/localtime`：如果设置市区为shanghai，系统会将`/usr/share/zoneinfo/Asia /Shanghai`复制并重命名为`/etc/localtime`

### 2 /etc/ntp.conf 和 /etc/ntp/ntp.conf

##### 2.1 driftfile记录时间差异

- 格式：`driftfile [（可以被ntpd写入的）绝对路径名]`
  
  - 需要使用完整路径文件名；
  
  - 不能是链接文件；
  
  - 需要设定成ntpd这个daemon可以写入的权限；
  
  - 所记录的数值单位为：百万分之一秒 (ppm)。

- ​ 用途：因为默认的NTP Server本身的时间计算是依据BIOS的芯片振荡周期频率来计算的，但是这个数值与上层Time Server不见得一致。所以NTP这个daemon(ntpd)会自动去计算我们自己主机的频率与上层Time Server的频率，并且将两个频率的误差记录下来，记录下来的文件就是在driftfile后面的完整文件名所指的文件。

##### 2.2 statsdir和filegen开启日志统计分析

- 格式：
  
  - `statsdir [目录路径]`
  
  - `filegen name file filename [type type] [link | nolink] [enable | disable]`

- 用途：当打开统计分析时，ntp会在 [目录路径] 下产生filegen中所设定的统计文件。

##### 2.3 restrict管理权限控制

- 格式：`restrict [address] mask [mask] [parameter]`
  
  - **restrict default**：对所有的IP有效
  
  - **nomodify**：客户端不能使用ntpc与ntpq这两个程序来修改服务器的时间参数，但客户端仍可透过这部主机来进行网络校时的；
  
  - **notrap**：不提供trap这个远程事件登录(remote event logging)的功能；
  
  - **nopeer**：不与其他同一层的ntp服务器进行时间同步；
  
  - **noquery**：客户端不能够使用ntpq,ntpc等指令来查询时间服务器，等于不提供NTP的网络校时；
  
  - **notrust**：拒绝没有认证的客户端。
  
  - **ignore**：拒绝所有类型的NTP连接；

- 用途：那如果没有在parameter的地方加上任何参数的话，这表示“该IP或网段不受任何限制”的意思。一般来说，我们可以先关闭NTP的权限，然后再一个一个地启用允许登录的网段。

##### 2.4 server设定上层NTP服务器

- 格式：`server [address] [options…]`

- 用途：在server后面填写服务器地址（可以是IP或主机名），之后是命令参数主要包括autokey，brust，ibrust，key，minpoll，maxpoll，mode option，noselect，preempy，prefer，true，ttl，version，xleave。这里最常使用的prefer，表示优先使用的服务器。

##### 2.5 keys 通过秘钥系统认证

- 格式：`keys [key_file]`

- 用途：除了以restrict来限制客户端的连接之外，我们也可以通过密钥系统来给客户端认证，如此一来，可以让主机端更放心了。

##### 2.6 ntp查看状态

```bash
ntpstat    # 查看ntp是否连接服务器
ntpq -p    # 列出相关上层NTP的状态
```

##### 2.7 Linux时钟校准

- Linux存在两个时钟
  
  - 软件时钟：Liux自己的系统时间，从1970年1月1日开始记录的时间参数。
  
  - 硬件时钟：计算机系统在BIOS记录的实际时间，这也是硬件所记录的。

- 当我们做完Linux时间的校时后，还需要用hwclock来更新BIOS的时间，因为每次重新启动的时候，系统会重新由BOS将时间读出来。

```bash
date            # 显示当前日期
date 时间戳      # 修改时间为时间戳指定时间
hwclock [-rw]   # -r读取BOIS时间 -w将系统时间写入BIOS
```



##### 2.6 默认配置

- ntp配置文件

```bash
######################### 默认配置 ##########################

driftfile /var/lib/ntp/ntp.drift
# Leap seconds definition provided by tzdata
leapfile /usr/share/zoneinfo/leap-seconds.list
# Enable this if you want statistics to be logged.
#statsdir /var/log/ntpstats/
statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable
# Specify one or more NTP servers.
# Use servers from the NTP Pool Project. Approved by Ubuntu Technical Board
# on 2011-02-08 (LP: #104525). See http://www.pool.ntp.org/join.html for
# more information.
pool 0.ubuntu.pool.ntp.org iburst
pool 1.ubuntu.pool.ntp.org iburst
pool 2.ubuntu.pool.ntp.org iburst
pool 3.ubuntu.pool.ntp.org iburst
# Use Ubuntu's ntp server as a fallback.
pool ntp.ubuntu.com
# Access control configuration; see /usr/share/doc/ntp-doc/html/accopt.html for
# details.  The web page <http://support.ntp.org/bin/view/Support/AccessRestrictions>
# might also be helpful.
#
# Note that "restrict" applies to both servers and clients, so a configuration
# that might be intended to block requests from certain clients could also end
# up blocking replies from your own upstream servers.
# By default, exchange time with everybody, but don't allow configuration.
restrict -4 default kod notrap nomodify nopeer noquery limited
restrict -6 default kod notrap nomodify nopeer noquery limited
# Local users may interrogate the ntp server more closely.
restrict 127.0.0.1
restrict ::1
# Needed for adding pool entries
restrict source notrap nomodify noquery

######################### 推荐配置 ##########################
# driftfile记录时间差异
driftfile /var/lib/ntp/drift    
# 允许与我们的时间源同步时间,但是不允许源查询或修改这个系统上的服务。
restrict default nomodify notrap nopeer noquery
# 对环回地址不做限制。可以对其约束，但这样会影响对ntp的管理。
restrict 127.0.0.1                  # IPV4本地回环地址
restrict ::1                        # IPV6本地回环地址
restrict default nomodify notrap
# 对本地网络的限制较少
restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap
# 只是用本地振荡频率计算时间
server 127.127.1.0 # local clock
fudge 127.127.1.0 stratum 8
# 
includefile /etc/ntp/crypto/pw
# 指定秘钥文件
keys /etc/ntp/keys
# 
disable monitor
```



# crontab

# 配置ubuntu22.04 远程桌面

## 1 安装桌面环境

- ubuntu-desktop

```bash
# 直接安装
apt install ubuntu-desktop

# 或者使用 tasksel 
apt install tasksel -y 
tasksel 
#选择 ubuntu-desktop
```

- 将系统引导设置为图形目标（不需要）

```bash
# systemctl set-default graphical.target 
```

- 下载并安装 Sunshine Ubuntu 22.04 

```bash
# 地址: https://github.com/LizardByte/Sunshine/releases
wget https://github.com/LizardByte/Sunshine/releases/download/v0.21.0/sunshine-ubuntu-22.04-amd64.deb
apt install -f ./sunshine-ubuntu-22.04-amd64.deb
```

- 下载 Nvidia 驱动补丁，为Nvidia 帧缓冲区拷贝打补丁。

```bash
# 地址: https://github.com/keylase/nvidia-patch
git clone https://github.com/keylase/nvidia-patch.git
cd nvidia-patch
./patch-fbc.sh
```

## 2 配置桌面环境

- 1.编辑 gdm 配置文件，禁用 wayland 并自动登录您要远程访问的用户。

```bash
vi /etc/gdm3/custom.conf
# 取消 WaylandEnable=false 前的 # 号注释
WaylandEnable=false
# 并将以下两行取消注释后，填写自动登录用户的用户名
AutomaticLoginEnable = true
AutomaticLogin = user # 替换为自己的用户名
```

- 2.切换到自动登录的用户，编辑 pipewire 配置文件以卸载蓝牙驱动程序
  
  - 否则连接时，pipewire 无法自动启动且Sunshine会崩溃，因为它将无法创建音频接收器。

```bash
su - user
mkdir -p ~/.config/pulse/
vi ~/.config/pulse/default.pa

# 包含以下内容
###unload 蓝牙硬件驱动模块
.ifexists module-bluetooth-policy.so
unload-module module-bluetooth-policy
.endif
.ifexists module-bluetooth-discover.so
unload-module module-bluetooth-discover
.endif
```

- 3.创建 edid 文件伪造连接的显示器。
  
  - edid文件应位于自动登录用户的家目录。

```bash
# wget https://raw.githubusercontent.com/games-on-whales/gow/master/docs/modules/ROOT/examples/edid.txt
# 安装 read-edid 和 edid-decode
apt install read-edid
apt install edid-decode

# 地址1 : https://github.com/linuxhw/EDID/tree/master
# 地址2 : https://gist.github.com/hinell/0ebaad01b771a70844204f295aaf03b7
# Don't forget to place `\` after EOLs
HEXSTR="\
00 ff ff ff ff ff ff 00 10 ac 18 f1 55 56 39 44\
0d 1f 01 03 0e 30 1b 78 ea b6 75 a6 55 52 9f 27\
0f 50 54 a5 4b 00 71 4f 81 80 a9 c0 d1 c0 01 01\
01 01 01 01 01 01 02 3a 80 18 71 38 2d 40 58 2c\
45 00 dc 0c 11 00 00 1e 00 00 00 ff 00 38 5a 47\
43 58 43 33 0a 20 20 20 20 20 00 00 00 fc 00 44\
45 4c 4c 20 45 32 32 32 30 48 0a 20 00 00 00 fd\
00 38 4c 1e 53 11 00 0a 20 20 20 20 20 20 00 a6";
echo -en $(echo "$HEXSTR" | sed -E 's/([0-9abcdef][0-9abcdef])[[:space:]]?/\\x\1/g') > BENQ-GW2000-BNQ7807-09AFF.edid.bin

# 另一种伪造显示器的思路
xrandr --newmode "1500x1000_60.00" 102.49 1500 1548 1580 1660 1000 1003 1013 1029 +hsync -vsync
xrandr --addmode VIRTUAL1 "1500x1000_60.00"
xrandr --output VIRTUAL1 --mode "1500x1000_60.00"
```

- 4.设置 Xorg 配置文件

```bash
# 运行 nvidia-xconfig 以创建 Xorg 配置文件
nvidia-xconfig
vi /etc/X11/xorg.conf
# 将屏幕部分替换为以下内容，edid设置为对应路径
Section "Screen"
    Identifier "Screen0"
    Device "Device0"
    Monitor "Monitor0"
    DefaultDepth 24
    Option "AllowEmptyInitialConfiguration" "True"
    Option "UseDisplayDevice" "DP-0"
    Option "CustomEDID" "DP-0:Edid Path"
    Option "ConnectedMonitor" "DP-0"
    SubSection "Display"
        Depth 24
    EndSubSection
EndSection

# 另一种方案
# 地址: https://superuser.com/questions/1278256/x-server-on-nvidia-card-with-no-screen/1278264#1278264
nvidia-xconfig -a --allow-empty-initial-configuration \
--use-display-device="DFP-0" --connected-monitor="DFP-0" \
--custom-edid="DFP-0:/root/edid.txt" 

# 创建一个 udev 规则以允许Sunshine创建输入设备。
echo 'KERNEL=="uinput", SUBSYSTEM=="misc", OPTIONS+="static_node=uinput", TAG+="uaccess"' | sudo tee /etc/udev/rules.d/85-sunshine.rules

# 开启防火墙端口
ufw allow 47984/tcp
ufw allow 47989/tcp
ufw allow 48010/tcp
ufw allow 47998/udp
ufw allow 47999/udp
ufw allow 48000/udp
ufw allow 48002/udp
ufw allow 48010/udp
```

```bash
# nvidia-xconfig: X configuration file generated by nvidia-xconfig
# nvidia-xconfig:  version 530.30.02

#Section "Screen"
#    Identifier     "Screen0"
#    Device         "Device0"
#    Monitor        "Monitor0"
#    DefaultDepth    24
#    Option         "Coolbits" "4"
#    SubSection     "Display"
#        Depth       24
#    EndSubSection
#EndSection

Section "ServerLayout"
    Identifier     "Layout0"
    Screen      0  "metaScreen"
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
EndSection

Section "Files"
EndSection

Section "Module"
    Load           "dbe"
    Load           "extmod"
    Load           "type1"
    Load           "freetype"
    Load           "glx"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "InputDevice"

    # generated from default
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "Monitor"
    Identifier     "Monitor0"
    VendorName     "Unknown"
    ModelName      "Unknown"
    Option         "DPMS"
    Option         "Enable" "true"
EndSection

Section "Device"
    Identifier     "Card0"
    Driver         "nvidia"
    VendorName     "NVIDIA Corporation"
    BoardName      "NVIDIA GeForce RTX 2080 Ti"
    Option "MetaModes" "1920x1080"
    Option "ConnectedMonitor" "DP-0"
    Option "ModeValidation" "NoDFPNativeResolutionCheck,NoVirtualSizeCheck,NoMaxPClkCheck,NoHorizSyncCheck,NoVertRefreshCheck,NoWidthAlignmentCheck"
EndSection

Section "Screen"
    Identifier     "metaScreen"
    Device         "Card0"
    Monitor        "Monitor0"
    DefaultDepth    24
    Option         "AllowEmptyInitialConfiguration" "True"
    Option         "UseDisplayDevice" "DFP-0"
    Option         "CustomEDID" "DFP-0:/root/edid.txt"
    Option         "ConnectedMonitor" "DFP-0"
    SubSection     "Display"
        Depth       24
        Modes      "1920x1080"
    EndSubSection
EndSection
```

- 5.配置sunshine服务

```bash
cat > /root/.config/systemd/user/Sunshine.service <<-EOF
[Unit]
Description=Sunshine is a self-hosted game stream host for Moonlight.
StartLimitIntervalSec=500
StartLimitBurst=5
Requires=pulseaudio.service
After=pulseaudio.service
[Service]
ExecStart=//usr/bin/sunshine
Restart=on-failure
RestartSec=5s
[Install]
WantedBy=graphical-session.target
EOF
systemctl --user daemon-reload

# 赋予权限
cat >> /home/user/.profile <<-EOF
export XDG_RUNTIME_DIR="/run/user/$UID"
export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
export DISPLAY=:0
EOF
sudo runuser user-l -c "systemctl --user enable Sunshine"

# 将 graphical.target 设置开机启动
systemctl set-default graphical.target


# 设置 /etc/X11/Xwrapper.config
# allowed_users = rootonly|console|anybody
allowed_users = anybody
```

## Ref

[How to set up Headless Sunshine on Ubuntu server 22.04 with an Nvidia gpu - Wikis &amp; How-to Guides - Level1Techs Forums](https://forum.level1techs.com/t/how-to-set-up-headless-sunshine-on-ubuntu-server-22-04-with-an-nvidia-gpu/197106)

[Remote SSH Headless Setup - Sunshine documentation](https://lizardbyte--1527.org.readthedocs.build/projects/sunshine/en/1527/about/guides/linux/headless_ssh.html)
